name: pushADFtoPROD
on:
  workflow_dispatch
  #push:
    #branches:
      #- adf_publish
jobs:
  build:
      runs-on: ubuntu-latest
      steps:
        - name: Checkout code
          uses: actions/checkout@v2
  
        - name: Validate ARM template
          uses: Azure/data-factory-validate-action@v1.1.5
         
        - name: Export Azure Data Factory
          id: export
          uses: Azure/data-factory-export-action@v1.2.0
               
        - name: Publish ARM template
          uses: actions/upload-artifact@v2
          with:
            name: adf-armtemplate
            path: ${{ steps.export.outputs.arm-template-directory }}
            if-no-files-found: error

  deploy:
    runs-on: windows-latest
    steps:
      # Log into Azure via Service Principal
      - name: Login via Az module
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          enable-AzPSSession: true 
          
      # Manually install Powershell module to work around error in data-factory-deploy-action
      - name: Install Az PowerShell module
        run: Install-Module -Name Az.DataFactory -AllowClobber -Scope CurrentUser -Repository PSGallery -Force
        shell: pwsh
      - name: Install Az PowerShell module
        run: Install-Module -Name Az.Billing -AllowClobber -Scope CurrentUser -Repository PSGallery -Force
        shell: pwsh
      - name: Install Az PowerShell module
        run: Install-Module -Name Az.DataLakeAnalytics -AllowClobber -Scope CurrentUser -Repository PSGallery -Force
        shell: pwsh
      - name: Install Az PowerShell module
        run: Install-Module -Name Az.DataLakeStore -AllowClobber -Scope CurrentUser -Repository PSGallery -Force
        shell: pwsh
      - name: Install Az PowerShell module
        run: Install-Module -Name Az.Storage -AllowClobber -Scope CurrentUser -Repository PSGallery -Force
        shell: pwsh

      #- name: Download ARM template
        #uses: actions/download-artifact@v3
        #with:
          #name: adf-armtemplate

      # Deploy ARM template to new data factory
      - name: Deploy resources
        uses: Azure/data-factory-deploy-action@v1.2.0
        with:
          resourceGroupName: Dudziak
          dataFactoryName: test-adf-deploy-prod
          # armTemplateFile: test-adf-deploy-dev/ARMTemplateForFactory.json
          # armTemplateParametersFile: myArmTemplateParameters.json [optional]
          # additionalParameters: 'key1=value key2=value keyN=value' [optional]
          # skipAzModuleInstallation: true [optional]
